name: Simple CI/CD for Diploma

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Create reports directory
      run: |
        mkdir -p security_reports
    
    - name: Run Bandit Scan
      run: |
        echo "Running Bandit security scan..."
        bandit -r src/ -f json -o security_reports/bandit_report.json --exit-zero
        echo "âœ… Bandit scan completed"
    
    - name: Run Semgrep Scan
      run: |
        echo "Running Semgrep scan..."
        if [ -f "custom-opengrep-rules.yml" ]; then
          semgrep --config custom-opengrep-rules.yml ./src --json -o security_reports/semgrep_report.json || true
        else
          semgrep --config auto ./src --json -o security_reports/semgrep_report.json || true
        fi
        echo "âœ… Semgrep scan completed"
    
    - name: Create Summary Report
      run: |
        echo "Creating summary report..."
        cat > security_reports/summary.md << 'EOF'
        # Ð”Ð¸Ð¿Ð»Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚: Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        
        ## ðŸ“… Ð”Ð°Ñ‚Ð°: $(date)
        
        ## ðŸ”§ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹:
        - Bandit: ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€ Python ÐºÐ¾Ð´Ð°
        - Semgrep/OpenGrep: ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€
        
        ## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:
        
        ### Bandit:
        - Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: JSON, HTML
        - ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº: Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ÑÑ
        
        ### Semgrep:
        - Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: JSON
        - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°: custom-opengrep-rules.yml
        
        ## ðŸŽ¯ Ð’Ñ‹Ð²Ð¾Ð´Ñ‹ Ð´Ð»Ñ Ð´Ð¸Ð¿Ð»Ð¾Ð¼Ð°:
        1. Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ CI/CD ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°
        2. Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð² Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ðµ
        3. ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ
        
        ## ðŸ“ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:
        - bandit_report.json
        - bandit_report.html
        - semgrep_report.json
        - summary.md
        
        *Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð»Ñ Ð´Ð¸Ð¿Ð»Ð¾Ð¼Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°*
        EOF
        
        echo "âœ… Summary report created"
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: diploma-security-reports
        path: |
          security_reports/*
        retention-days: 90
