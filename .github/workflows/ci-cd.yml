name: CI/CD Pipeline for Security Scanner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run tests
        run: |
          python -m pytest tests/ -v

  security_scan:
    runs-on: ubuntu-latest
    needs: build
    name: Security Scan (Bandit + OpenGrep)
    steps:
      - uses: actions/checkout@v4
      
      - name: Install security tools
        run: |
          pip install bandit semgrep
          
      - name: Run Bandit SAST Scan
        run: |
          echo "=== BANDIT SAST SCAN ==="
          bandit -r src/ -f json -o bandit_report.json
          echo "Bandit scan completed"
          
      - name: Run OpenGrep with Custom Rules
        run: |
          echo "=== OPENGREP WITH CUSTOM RULES ==="
          semgrep --config custom-opengrep-rules.yml ./src --sarif -o opengrep_custom.sarif
          echo "Custom rules scan completed"
          
      - name: Run OpenGrep OWASP Analysis
        run: |
          echo "=== OPENGREP OWASP ANALYSIS ==="
          semgrep --config "p/owasp-top-ten" ./src --sarif -o opengrep_owasp.sarif
          echo "OWASP analysis completed"
          
      - name: Generate Comparison Report
        run: |
          echo "=== GENERATING COMPARISON REPORT ==="
          cat > comparison.md << 'EOF'
          # Security Tools Comparison
          ## Bandit vs OpenGrep Results
          ### Date: $(date)
          
          Методология сравнения:
          1. Bandit - специализированный инструмент для статического анализа Python кода
          2. OpenGrep/Semgrep - универсальный статический анализатор с поддержкой custom правил
          
          Bandit Findings:
          EOF
          
          echo '```json' >> comparison.md
          cat bandit_report.json | head -50 >> comparison.md
          echo '```' >> comparison.md
          
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-reports
          path: |
            bandit_report.json
            opengrep_*.sarif
            comparison.md
          retention-days: 30
