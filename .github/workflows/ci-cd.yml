name: CI/CD Pipeline for Security Scanner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run tests
        run: |
          python -m pytest tests/ -v

  security_scan:
    runs-on: ubuntu-latest
    needs: build
    name: Security Scan (Bandit + OpenGrep)
    steps:
      - uses: actions/checkout@v4
      
      - name: Install security tools
        run: |
          pip install bandit semgrep pbr
          
      - name: Run Bandit SAST Scan
        run: |
          echo "=== BANDIT SAST SCAN ==="
          bandit -r src/ -f json -o bandit_report.json --exit-zero
          echo "âœ… Bandit found vulnerabilities (exit-zero used to continue pipeline)"
          echo "Ð­Ñ‚Ð¾ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾ Ð´Ð»Ñ Ð´Ð¸Ð¿Ð»Ð¾Ð¼Ð° - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÐºÐ°Ð½ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"

      - name: Analyze Bandit Results
        run: |
          echo "=== ÐÐÐÐ›Ð˜Ð— Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’ BANDIT ==="
          if [ -f "bandit_report.json" ]; then
            VULN_COUNT=$(jq '.results | length' bandit_report.json)
            echo "ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹: $VULN_COUNT"
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "ðŸ“‹ Ð¢ÐžÐŸ-3 Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹:"
              jq -r '.results[0:3][] | "  - \(.issue_text) (Severity: \(.issue_severity))"' bandit_report.json
            else
              echo "âœ… Ð£ÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
            fi
          else
            echo "âš ï¸ Ð¤Ð°Ð¹Ð» bandit_report.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
          
      - name: Run OpenGrep with Custom Rules
        run: |
          echo "=== OPENGREP WITH CUSTOM RULES ==="
          semgrep --config custom-opengrep-rules.yml ./src --sarif -o opengrep_custom.sarif
          echo "Custom rules scan completed"
          
      - name: Run OpenGrep OWASP Analysis
        run: |
          echo "=== OPENGREP OWASP ANALYSIS ==="
          semgrep --config "p/owasp-top-ten" ./src --sarif -o opengrep_owasp.sarif
          echo "OWASP analysis completed"
          
      - name: Generate Comparison Report
        run: |
          echo "=== GENERATING COMPARISON REPORT ==="
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Markdown Ð¾Ñ‚Ñ‡ÐµÑ‚ Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¼ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
          cat > comparison.md << 'EOF'
          # Security Tools Comparison
          ## Bandit vs OpenGrep Results
          
          ÐœÐµÑ‚Ð¾Ð´Ð¾Ð»Ð¾Ð³Ð¸Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ:
          1. **Bandit** - ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Python ÐºÐ¾Ð´Ð°
          2. **OpenGrep/Semgrep** - ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ custom Ð¿Ñ€Ð°Ð²Ð¸Ð»
          
          Bandit Findings:
          EOF
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Bandit
          if [ -f "bandit_report.json" ]; then
            echo '```json' >> comparison.md
            head -50 bandit_report.json >> comparison.md
            echo '```' >> comparison.md
          fi
          
          echo "âœ… Comparison report generated"
          
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-reports
          path: |
            bandit_report.json
            opengrep_*.sarif
            comparison.md
          retention-days: 30
