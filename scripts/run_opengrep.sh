#!/bin/bash

# ============================================
# Ð¡ÐšÐ Ð˜ÐŸÐ¢ Ð”Ð›Ð¯ Ð—ÐÐŸÐ£Ð¡ÐšÐ OPENGREP/SEMGREP ÐÐÐÐ›Ð˜Ð—Ð
# Ð˜ Ð¡Ð ÐÐ’ÐÐ•ÐÐ˜Ð¯ Ð¡ BANDIT
# Ð”Ð¸Ð¿Ð»Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ - Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
# ============================================

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     Ð¡Ð ÐÐ’ÐÐ•ÐÐ˜Ð• BANDIT vs OPENGREP             â•‘"
echo "â•‘     Ð”Ð¸Ð¿Ð»Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ 2025                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð»Ð¸ semgrep
if ! command -v semgrep &> /dev/null; then
    echo "âŒ Semgrep Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
    pip install semgrep
fi

echo "âœ… Semgrep Ð²ÐµÑ€ÑÐ¸Ð¸: $(semgrep --version)"
echo "ðŸ“… Ð”Ð°Ñ‚Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°: $(date)"
echo "ðŸ“ ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼Ð°Ñ Ð¿Ð°Ð¿ÐºÐ°: ./src"
echo ""

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
REPORT_DIR="./security_reports"
mkdir -p "$REPORT_DIR"

# ========================
# Ð—ÐÐŸÐ£Ð¡Ðš BANDIT
# ========================
echo "ðŸ” Ð—ÐÐŸÐ£Ð¡Ðš BANDIT ÐÐÐÐ›Ð˜Ð—Ð..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if command -v bandit &> /dev/null; then
    bandit -r ./src -f json -o "${REPORT_DIR}/bandit_report.json"
    bandit -r ./src -f html -o "${REPORT_DIR}/bandit_report.html"
    
    # ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Bandit
if [ -f "${REPORT_DIR}/bandit_report.json" ]; then
    BANDIT_COUNT=$(jq '.results | length' "${REPORT_DIR}/bandit_report.json" 2>/dev/null || echo "0")
else
    BANDIT_COUNT="0"
fi

# ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ OpenGrep
OPENGREP_TOTAL=0
for report in "${REPORT_DIR}"/opengrep_*.json; do
    if [ -f "$report" ]; then
        COUNT=$(jq '.results | length' "$report" 2>/dev/null || echo "0")
        OPENGREP_TOTAL=$((OPENGREP_TOTAL + COUNT))
        echo "   ðŸ“Š $(basename $report): $COUNT ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
    fi
done

# ========================
# Ð—ÐÐŸÐ£Ð¡Ðš OPENGREP/SEMGREP
# ========================
echo ""
echo "ðŸ” Ð—ÐÐŸÐ£Ð¡Ðš OPENGREP/SEMGREP ÐÐÐÐ›Ð˜Ð—Ð..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# 1. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð½Ð°ÑˆÐ¸ custom Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
echo "1. Custom Rules Ð°Ð½Ð°Ð»Ð¸Ð·..."
if [ -f "custom-opengrep-rules.yml" ]; then
    semgrep --config custom-opengrep-rules.yml ./src --json -o "${REPORT_DIR}/opengrep_custom.json"
    semgrep --config custom-opengrep-rules.yml ./src --sarif -o "${REPORT_DIR}/opengrep_custom.sarif"
    echo "   âœ… Custom rules Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"
else
    echo "   âš ï¸ Ð¤Ð°Ð¹Ð» custom-opengrep-rules.yml Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
fi

# 2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° OWASP Top 10
echo "2. OWASP Top 10 Ð°Ð½Ð°Ð»Ð¸Ð·..."
semgrep --config "p/owasp-top-ten" ./src --json -o "${REPORT_DIR}/opengrep_owasp.json" 2>/dev/null || echo "   âš ï¸ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° OWASP Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹"

# 3. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð´Ð»Ñ Python
echo "3. Python Security Ð°Ð½Ð°Ð»Ð¸Ð·..."
semgrep --config "p/python" ./src --json -o "${REPORT_DIR}/opengrep_python.json" 2>/dev/null || echo "   âš ï¸ ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Python Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹"

# ========================
# Ð¡Ð ÐÐ’ÐÐ•ÐÐ˜Ð• Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’
# ========================
echo ""
echo "ðŸ“Š Ð¡Ð ÐÐ’ÐÐ•ÐÐ˜Ð• Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’ BANDIT vs OPENGREP..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
cat > "${REPORT_DIR}/comparison_report.md" << EOF
# Ð¡Ð ÐÐ’ÐÐ˜Ð¢Ð•Ð›Ð¬ÐÐ«Ð™ ÐžÐ¢Ð§Ð•Ð¢: BANDIT vs OPENGREP
## Ð”Ð¸Ð¿Ð»Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÐ°Ð½ÐµÑ€ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹

### Ð”Ð°Ñ‚Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°: $(date)

### ÐœÐµÑ‚Ð¾Ð´Ð¾Ð»Ð¾Ð³Ð¸Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ:
1. **Bandit** - ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Python ÐºÐ¾Ð´Ð°
2. **OpenGrep/Semgrep** - ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ custom Ð¿Ñ€Ð°Ð²Ð¸Ð»

### Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:

#### Bandit:
- Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ‹Ð²Ð¾Ð´Ð°: JSON, HTML
- ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼: $BANDIT_COUNT
- Ð¤Ð¾ÐºÑƒÑ: Python-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸

#### OpenGrep/Semgrep:
- Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ‹Ð²Ð¾Ð´Ð°: JSON, SARIF
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
  - Custom rules (Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°)
  - OWASP Top 10 (Ð¾Ð±Ñ‰ÐµÐ¿Ñ€Ð¸Ð½ÑÑ‚Ñ‹Ð¹ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚)
  - Python security rules (ÑÐ·Ñ‹ÐºÐ¾Ð²Ñ‹Ðµ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸)

### Ð’Ñ‹Ð²Ð¾Ð´Ñ‹ Ð´Ð»Ñ Ð´Ð¸Ð¿Ð»Ð¾Ð¼Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:
1. **Bandit** Ð»ÑƒÑ‡ÑˆÐµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð²Ð°ÐµÑ‚ Python-ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
2. **OpenGrep** Ð±Ð¾Ð»ÐµÐµ Ð³Ð¸Ð±Ð¾Ðº Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐµ custom Ð¿Ñ€Ð°Ð²Ð¸Ð»
3. Ð”Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ð¾Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð±Ð° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð°
4. Custom Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° OpenGrep Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÑŽÑ‚ Ð¸ÑÐºÐ°Ñ‚ÑŒ domain-specific ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸

### Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð² CI/CD:
- Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Bandit Ð´Ð»Ñ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Python ÐºÐ¾Ð´Ð°
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ OpenGrep Ñ custom Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
- ÐšÐ¾Ð¼Ð±Ð¸Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

---

*ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸. ÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð´Ð¸Ð¿Ð»Ð¾Ð¼Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° 2025.*
EOF

echo "âœ… Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½: ${REPORT_DIR}/comparison_report.md"
echo ""
echo "ðŸ“Š Ð’Ð¡Ð• ÐžÐ¢Ð§Ð•Ð¢Ð« Ð¡ÐžÐ¥Ð ÐÐÐ•ÐÐ« Ð’: ${REPORT_DIR}/"
ls -la "${REPORT_DIR}/"
echo ""
echo "ðŸŽ¯ Ð”Ð›Ð¯ ÐŸÐ ÐžÐ¡ÐœÐžÐ¢Ð Ð Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’:"
echo "   cat ${REPORT_DIR}/comparison_report.md"
echo "   cat ${REPORT_DIR}/bandit_report.json | jq '.results[].issue_text'"
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð³Ð¾Ñ‚Ð¾Ð²                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
