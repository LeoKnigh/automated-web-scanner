image: python:3.9

stages:
  - build
  - test
  - security_scan
  - network_scan

build:
  stage: build
  script:
    - echo "Установка зависимостей..."
    - pip install -r requirements.txt
    - echo "Сборка завершена"

test:
  stage: test
  script:
    - echo "Запуск тестов..."
    - pip install pytest
    - python -m pytest tests/ -v || echo "Тесты не найдены"
  dependencies:
    - build

bandit_scan:
  stage: security_scan
  script:
    - echo "Проверка безопасности..."
    - pip install bandit
    - bandit -r src/ -f html -o bandit_report.html || true
  artifacts:
    paths:
      - bandit_report.html

code_static_scan:  # Новое название job'а
  stage: network_scan  # Стадия остаётся прежней!
  image: python:3.9-slim
  variables:
    # Указываем путь к проекту для сканирования (можно изменить)
    SCAN_PATH: "./test_project"
  before_script:
    - pip install semgrep
    - git clone https://github.com/opengrep/opengrep-rules.git || echo "Правила уже существуют"
    - rm -rf ./opengrep-rules/stats/  # Удаляем проблемную папку
  script:
    - echo "=== Запуск статического анализа кода с Opengrep/Semgrep ==="
    # Сканируем указанный путь. Флаг --error завершит job с ошибкой при находке уязвимостей.
    - semgrep scan --config ./opengrep-rules --sarif --error -o semgrep_report.sarif $SCAN_PATH
    - echo "=== Сканирование завершено ==="
  artifacts:
    paths:
      - semgrep_report.sarif  # Сохраняем отчёт в формате SARIF
    expire_in: 1 week
  allow_failure: false  # Пусть пайплайн "падает", если найдены критические проблемы